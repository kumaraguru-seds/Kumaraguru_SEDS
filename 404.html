<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Redirecting...</title>
    <script>
        // !! PASTE YOUR GOOGLE APPS SCRIPT WEB APP /exec URL HERE !!
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzFISYfxIlxESJd_6dixnZxovBavgUpm_ldDcv9ZRTB9kHUVkCaTO7rvY_KAtyDJcJp/exec';
        // IPINFO is used for reliable, free, HTTPS analytics data
        const ANALYTICS_API_URL = 'https://ipinfo.io/json'; 

        async function logAndRedirect() {
            const path = window.location.pathname.substring(1).split('?')[0];

            if (!path || path.toLowerCase() === 'shorturl.html') {
                window.location.replace('/shorturl.html');
                return;
            }

            const messageEl = document.getElementById("message");
            const subMessageEl = document.getElementById("submessage");
            
            // --- 1. Gather Analytics Data (Background Task) ---
            const userAgent = navigator.userAgent || 'N/A';
            const clickTimestamp = new Date().toISOString();
            let analyticsData = { ip: 'N/A', city: 'N/A', country: 'N/A', isp: 'N/A' };

            // Start the analytics fetch immediately (non-blocking)
            const analyticsPromise = fetch(ANALYTICS_API_URL).then(r => r.json()).catch(() => ({}));

            // --- 2. Fetch Redirect URL from GitHub (Main Task) ---
            const linksJsonUrl = `/links.json?t=${Date.now()}`;
            
            try {
                // Fetch Link Data
                const linkResponse = await fetch(linksJsonUrl, { cache: "no-store" });

                if (!linkResponse.ok) {
                    throw new Error(`Could not load links data (${linkResponse.status}).`);
                }

                const linksData = await linkResponse.json();
                const longUrl = linksData[path];

                if (longUrl && typeof longUrl === 'string' && longUrl.startsWith('http')) {
                    // 3. Wait for Analytics (Max 500ms) and Send Log
                    const data = await Promise.race([
                        analyticsPromise,
                        new Promise(resolve => setTimeout(resolve, 500)) // Timeout promise
                    ]);

                    if (data && data.ip) {
                        analyticsData = {
                            ip: data.ip || 'N/A',
                            city: data.city || 'N/A',
                            country: data.country || 'N/A',
                            isp: data.org || 'N/A'
                        };
                    }

                    // Send Analytics Log to Apps Script
                    const loggingPayload = {
                        action: 'LOG_ANALYTICS',
                        slug: path,
                        ip: analyticsData.ip,
                        city: analyticsData.city,
                        country: analyticsData.country,
                        isp: analyticsData.isp,
                        userAgent: userAgent,
                        clickTimestamp: clickTimestamp
                    };

                    fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(loggingPayload),
                        mode: 'cors'
                    }).catch(e => console.error("Analytics Logging Failed:", e));
                    
                    // 4. Perform Redirect
                    window.location.replace(longUrl); 

                } else {
                    throw new Error(`Short link '/${path}' not found or URL is invalid.`);
                }

            } catch (error) {
                console.error("Redirect logic failed:", error);
                if (messageEl) messageEl.textContent = `Error: Link Not Found`;
                if (subMessageEl) subMessageEl.textContent = error.message;
            }
        }
        
        logAndRedirect();
    </script>
    <style> body { font-family: sans-serif; text-align: center; padding-top: 100px; } </style>
</head>
<body>
    <h1 id="message">Gathering Analytics & Redirecting...</h1>
    <p id="submessage">Please wait a moment.</p>
</body>
</html>
