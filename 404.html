<!DOCTYPE html>
<html>
<head>
    <title>Redirecting...</title>
    <script>
        // !! 1. PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE !!
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkGa_cVm1BbRnrN5Cq9gDdJgOYe9mCA7IWj6f6neWCqQud6fUH9Xs6JPqC8ctByfTf/exec'; 

        // !! 2. PASTE YOUR IPSTACK API KEY HERE !!
        // (Warning: This key will be visible to the public in your site's code)
        const IPSTACK_API_KEY = 'b2fc0a2c2e11067a6db961e7d9f72003';
        
        (async function() {
            // 3. Get the slug from the path
            const path = window.location.pathname.substring(1);
            
            if (!path || path.toLowerCase() === 'shorturl.html') {
                window.location.replace('/shorturl.html'); 
                return;
            }

            // 4. Get User Agent (Browser)
            const userAgent = encodeURIComponent(navigator.userAgent || 'Unknown');

            let ip = 'N/A';
            let city = 'N/A';
            let country = 'N/A';
            let isp = 'N/A';

            try {
                // 5. Fetch IP and Geolocation details from ipstack
                // Note: The free ipstack plan uses HTTP, which may cause "Mixed Content"
                // issues on some browsers. Their paid plans offer HTTPS.
                // We use "check" to get the user's own IP
                const api_url = `http://api.ipstack.com/check?access_key=${IPSTACK_API_KEY}&fields=ip,city,country_name,connection`;
                
                const response = await fetch(api_url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success === false) {
                         console.error("ipstack API error:", data.error.info);
                    } else {
                        ip = encodeURIComponent(data.ip || 'N/A');
                        city = encodeURIComponent(data.city || 'N/A');
                        country = encodeURIComponent(data.country_name || 'N/A');
                        
                        // ISP is inside the "connection" object
                        if (data.connection) {
                            isp = encodeURIComponent(data.connection.isp || 'N/A');
                        }
                    }
                }
            } catch (error) {
                // This catch block is important, especially if the API fails
                // or you hit your 100-request limit.
                console.error("IP API fetch failed:", error);
            }

            // 6. Build the final URL with all analytics parameters
            const finalRedirectUrl = `${APPS_SCRIPT_URL}?slug=${path}&ip=${ip}&city=${city}&country=${country}&isp=${isp}&ua=${userAgent}`;
            
            // 7. Redirect to the Apps Script
            window.location.replace(finalRedirectUrl);

        })();
    </script>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 100px; }
    </style>
</head>
<body>
    <h1>Redirecting & Gathering Analytics...</h1>
    <p>Please wait a moment.</p>
</body>
</html>
